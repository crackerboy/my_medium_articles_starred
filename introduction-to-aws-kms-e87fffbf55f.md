
# Introduction to AWS KMS

What is KMS?

*AWS Key Management Service (AWS KMS) is a managed service that makes it easy for you to create and control the encryption keys used to encrypt your data.*
> ***Advantage***

* *We can use IAM Policies for KMS access*

* *AWS Services(RDS,S3,DynamoDB,EBS…) integrated directly with KMS [*https://docs.aws.amazon.com/kms/latest/developerguide/service-integration.html](https://docs.aws.amazon.com/kms/latest/developerguide/service-integration.html)

* *It uses FIPS 140–2 compliant hardware module to manage access to key material.*

* *Integrated fully with CloudTrail for auditing function*
> ***Concepts***

* *KMS stores Customer Master Keys(CMK) which is a logical representation of a key.*

* *Key can be generated by KMS or imported.*

* *The encrypted data keys are stored with the data*

* *CMK never leaves KMS and never leaves a region*

* *CMK can encrypt or decrypt data up to 4KB in size.*
> ***How KMS Encrypt Data***

![](https://cdn-images-1.medium.com/max/2000/1*a0bA32jO9PXvwgw76Xmu3w.png)

*Reference: [https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping](https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping)*

* *We start with the plain text and then uses data keys along with an algorithm and come up with encrypted data.*

* *Encrypted data is finally stored in a storage that can be anything(eg:EBS, EFS, S3…)*

* *KMS then took data key, Encrypt it with a master key along with an encryption algorithm, resulted in it an encrypted data key, that stored alongside with data.*
> ***KMS in action***

    # To access KMS

    *Go to AWS Console --> Security, Identity, & Compliance --> Key Management Service --> Create a key*

*NOTE: YAY!!!, Now Key Management Service got its a new home but you can still access it via old way i.e*

    *AWS Console --> IAM --> Encryption keys*
> ***Step1:***

![](https://cdn-images-1.medium.com/max/3480/1*rZIJUS5fAEIfFYSzIFfMeA.png)

    ** Alias: Enter an alias and descrption for the key(eg: Alias: mydemotestkey, similarly Descrption)
    * Key material origin: Choose KMS(External: You can bring your own Key(BUOY),CloudHSM(More about it later)*
> ***Step2:***

![](https://cdn-images-1.medium.com/max/2516/1*eJU5wguQf6GeL0uhk6zDTQ.png)

    ** Adding Tag is Optional but its a good practice*

***Step3:***

* *Choose the users and roles who can administer this key.*

* *This is critical as an administrator have right to delete these keys and after that, your data will become unusable*

![](https://cdn-images-1.medium.com/max/2560/1*19FFUW1LewaURGTnUj-chw.png)
> ***Step4: **Define key usage permissions,select the IAM users and roles that can use the CMK to encrypt and decrypt data with the AWS KMS API*

![](https://cdn-images-1.medium.com/max/2528/1*J8gbdSKofKqxqn72DOhJlg.png)

***Step5: **Review and edit key policy*
> ***Encrypt EBS Volume using KMS Key***

    *AWS Console --> EC2 --> ELASTIC BLOCK STORE --> Volumes --> Create Volume*

![](https://cdn-images-1.medium.com/max/4264/1*cLxxYsihZb7tfYz-bdFE1w.png)

    ** Check the Encryption tab
    * Under Master Key(Select the KMS we just created from the drop down)*

*If you go back to the Volume, you will see something like this*

![](https://cdn-images-1.medium.com/max/5028/1*sYiwHfI8oNyk2fl26yLhSA.png)

*To summarize this how it works*

* *When we create an EBS Volume, the encrypted data key is stored with the Volume.*

* *Now Instance is going to request KMS to un-encrypt this data key and that Plain Text data key is stored in Hypervisor.*

* *All the future request of encryption and decryption is now taken care by this Plain Text Data Key.*
> ***Encrypt S3 bucket using KMS Key***

*Let’s take an example of S3 and how to encrypt S3 bucket using KMS*

* *Every S3 bucket object is encrypted using DataKey provided by KMS*

* *This DataKey is generated from a CMK(or by custom CMK)*

* *Cipher Key is stored along with data inside S3 bucket as metadata*

* *When decryption is needed, the cipher key is passed to KMS and the decrypted key is used by S3 to decrypt the object*

*Now when uploading any file to your bucket choose the KMS key*

![](https://cdn-images-1.medium.com/max/3460/1*ojPkePchgOOIEPfeyTXbeg.png)
> ***Generating KMS Keys using AWS CLI***
> ***Step1: Create Customer Master Key***

    *# **aws kms create-key --description "my demo test key using aws cli"***

    *{*

    *"KeyMetadata": {*

    *"Origin": "AWS_KMS",*

    ***"KeyId": "47f57428-6d1f-4e14-a69b-ca4bb7d3cc3d",***

    *"Description": "my demo test key using aws cli",*

    ***"KeyManager": "CUSTOMER",***

    *"Enabled": true,*

    *"KeyUsage": "ENCRYPT_DECRYPT",*

    *"KeyState": "Enabled",*

    *"CreationDate": 1545684587.762,*

    *"Arn": "arn:aws:kms:us-west-2:XXXXXXXXX:key/47f57428-6d1f-4e14-a69b-ca4bb7d3cc3d",*

    *"AWSAccountId": "XXXXXXXXX"*

    *}*

    *}*

* *create-key is going to create customer master key*

* *Let focus on some key parameter,KeyID this is the unique key identifier*

* *KeyManager will tell us if this is managed by AWS(anything starts with aws is an aws managed key)or its customer Managed keys(key that is created by us)*

![](https://cdn-images-1.medium.com/max/4420/1*UmNpZOa-eejdBA9gIUlUCg.png)

***Step2: Create an alias***

    *# **aws kms create-alias --target-key-id "47f57428-6d1f-4e14-a69b-ca4bb7d3cc3d" --alias-name "alias/myawsclidemokey"***

* *An alias can think like a shortcut, rather than specifying key id we can manage or use key using its alias.*

* *At this point in time, if we can go back to the AWS Console and check*

![](https://cdn-images-1.medium.com/max/4560/1*1aiWSGXy-H6vF-9N8NryEA.png)

***Step3: Next step is to create data key***

* *We never used Customer Master Key(CMK) for encrypt purpose rather than based on an application it generates a data encryption key in two format(plain text as well as encrypted data key)*

* *Plain text is used to encrypt data and will be discarded after that, while the cipher key is saved along with the data.*

    *# **aws kms generate-data-key --key-id "alias/myawsclidemokey" --key-spec AES_256***

    *{*

    *"**Plaintext**": "SyifeebmQ0VHWvBM7tfwjJc046kRWkLT+k7+jk5n55E=",*

    *"KeyId": "arn:aws:kms:us-west-2:XXXXXXX:key/47f57428-6d1f-4e14-a69b-ca4bb7d3cc3d",*

    *"**CiphertextBlob**": "AQIDAHhHSrJdgnVcuGBLUuSWdnVJ0V5VXp8mpA/9/2cYr5cLLgEsgHrzkC9qj+mJtTCIPeQbAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMT6UMBpbal/GaYA6lAgEQgDsl0Du2aE/82NeheqmRLaOC6uZaMNyqdarXLwSPfojFbdyRRCUhtfg856ceO3VUttTqhl+K4Mj11PHqlg=="*

    *}*

* *As you can see in the above output we got two versions of the same key*

    ** Plain Text Key(Plaintext)
    * Encrypted Version of Key(CiphertextBlob)*

* *Save the encrypted version of key to a file*

    *# echo "AQIDAHhHSrJdgnVcuGBLUuSWdnVJ0V5VXp8mpA/9/2cYr5cLLgEsgHrzkC9qj+mJtTCIPeQbAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMT6UMBpbal/GaYA6lAgEQgDsl0Du2aE/82NeheqmRLaOC6uZaMNyqdarXLwSPfojFbdyRRCUhtfg856ceO3VUttTqhl+K4Mj11PHqlg==" >> **my_cipher_base64.txt***

* *Similarly, temporarily save the plain text version to a file*

    *# echo "SyifeebmQ0VHWvBM7tfwjJc046kRWkLT+k7+jk5n55E=" >> my_plain_base64.txt*

* *Decode base64 encoded key*

    *# cat my_plain_base64.txt |base64 --decode >> my_plaintextfile.txt*

* *Using the plain text we decoded earlier, let’s try to encrypt the data*

    *# echo "AWS is awesome" |openssl enc -e -aes256 -k fileb://root/my_plaintextfile.txt  > ~/my_decodeded_test*

    *# cat my_decodeded_test*

    *Salted__]?qR??E?T??%;???ڮ?8?!*
> ***How to Import your own key/Bring External key into KMS***

![](https://cdn-images-1.medium.com/max/3072/1*x9W7cN4R2l6Efkx33k45ug.png)

* *This time choose the External option*

* *All the other steps(Step2 — Step5) are the same as we create the key earlier but this time once you pressed finish, it will leave you to this screen*

![](https://cdn-images-1.medium.com/max/4380/1*uIcU-g38s5-xh1-FSuPhwg.png)

* *Under Select wrapping algorithm choose RSAES_OAEP_SHA_1*

* Download wrapping key and import token

* *Use openssl to generate a 256-bit symmetric key*

    *$ openssl rand -out plain_text_aes_key.bin 32*

* *Wrap the Secret Key with wrappingKey, UnZIP and put the wrapping key into the same directory that contains your Secret Key.*

    *$ openssl rsautl -encrypt \*

    *>                -in plain_text_aes_key.bin \*

    *>                -oaep \*

    *>                -inkey wrappingKey_XXXXXX \*

    *>                -pubin \*

    *>                -keyform DER \*

    *>                -out enc.aes.key*

![](https://cdn-images-1.medium.com/max/3176/1*EAt5cEhUEy3yDUpIQOEWiw.png)

* *Now import the Wrapped key we just generated and Import Token*
> ***Key Deletion***

* *You can’t delete key immediately, rather then you need to schedule it*

![](https://cdn-images-1.medium.com/max/5064/1*kGhNkyqkTw7yEDNUcgONJw.png)

* *The waiting period is from 7–30 days, this is to make sure you understand that deleting a key makes all data encrypted under that key unrecoverable*

![](https://cdn-images-1.medium.com/max/2340/1*yJPVkhDhEW9kSOrM8Rwcbg.png)
> ***Key Rotation***

* ***AWS managed CMKs.** You cannot manage key rotation for AWS managed CMKs. AWS KMS automatically rotates AWS managed keys **every three years (1095 days).***

* *When you enable automatic key rotation, **AWS KMS rotates the CMK 365 days** after the enable date and every 365 days thereafter.*

![](https://cdn-images-1.medium.com/max/5080/1*_iPvM_fKdTJqVqiN4UFuOQ.png)
> ***KMS Limits***

![](https://cdn-images-1.medium.com/max/2880/1*_hAWJb6XPi5L5UHk6ZhDbQ.png)

![](https://cdn-images-1.medium.com/max/3276/1*hD2F54tTNUjFZi7t3z5t0Q.png)
[**Limits - AWS Key Management Service**
*Learn the default maximums that apply to AWS Key Management Service (AWS KMS) resources such as keys, aliases, grants…*docs.aws.amazon.com](https://docs.aws.amazon.com/kms/latest/developerguide/limits.html#requests-per-second-table)

***NOTE:** When a request is throttled, AWS KMS returns a ThrottlingException error*
> ***Cloud Hardware Security Module(HSM)***

* *It’s a physical device used for secure key storage and management*

* *Dedicated Device managed by AWS(but they don’t have access to cryptographic keys)*

* *It can be deployed in your VPC and separated from other networks for latency and security reason*

* *Can be placed in Multi-AZ and clustered(Load Balancer and Replicated Keys)*

* *Perfect Solution if your organization needs keys to be kept in dedicated hardware.*

* *Cloud HSM supports FIPS 140 — Level3*

* *While KMS is integrated well with other AWS Services, to interact with CloudHSM we need to use industry standard API, no normal AWS API’s.*

![](https://cdn-images-1.medium.com/max/2040/1*IhVK2IvUGfwd5DHFQ-nGNA.jpeg)
