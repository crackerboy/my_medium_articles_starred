Unknown markup type 10 { type: [33m10[39m, start: [33m12[39m, end: [33m33[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m38[39m, end: [33m69[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m17[39m, end: [33m26[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m11[39m, end: [33m34[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m179[39m, end: [33m194[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m34[39m, end: [33m71[39m }
Unknown markup type 10 { type: [33m10[39m, start: [33m123[39m, end: [33m135[39m }

# Practical Monitoring with Prometheus & Grafana (Part IV)

Securing Grafana with Identity-Aware Proxy

![Photo by [Mitchell Luo](https://unsplash.com/@mitchel3uo?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)](https://cdn-images-1.medium.com/max/3170/1*Kh5QabvO6Ukd4VrI8nCCLw.jpeg)*Photo by [Mitchell Luo](https://unsplash.com/@mitchel3uo?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)*

In [Parts I](https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-i-22d0f172f993), [II](https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-ii-5020be20ebf6), and [III](https://towardsdatascience.com/practical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19) of the Practical Monitoring with Prometheus & Grafana series, we deployed Prometheus and Grafana on Kubernetes, installed blackbox probes, and configured anomaly detection to make a foundation for our monitoring stack. In this last post, we will complete the setup and look at securing Grafana using [Google Cloudâ€™s Identity-Aware Proxy (IAP)](https://cloud.google.com/iap).

## Identity-Aware Proxy (IAP)

Grafana, by default, provides a username/password authentication mechanism to restrict access to the dashboards. Admin passwords are autogenerated at the time of install and stored as a Kubernetes secret. It also supports Lightweight Directory Access Protocol (LDAP) to integrate Active Directory and other directory services for authentication.

![Default Grafana Login Page](https://cdn-images-1.medium.com/max/2916/1*N7EHBJpR7k5XWiw2i81vxg.png)*Default Grafana Login Page*

So that deals with user authentication, but how do we deal with access to Grafana? Itâ€™s not feasible to expect SREs or engineers on call to use port-forwarding on every cluster to access Grafana on localhost. Projects like [kube-forwarder](https://github.com/pixel-point/kube-forwarder) make the mechanism of switching contexts and forwarding ports easy, but what if you donâ€™t want to give everyone access to Kubernetes but still want them to see the Grafana dashboards? The other option is to expose Grafana via an Ingress and configure firewall rules to restrict access via VPN or bastion hosts, which can be tricky and potentially expensive to set up.

Google Cloudâ€™s IAP is a simpler authentication and authorization mechanism to enable a zero-trust security model without VPNs. It builds on Googleâ€™s [BeyondCorp](https://cloud.google.com/beyondcorp/) model of shifting security from network perimeters to individuals users and uses context to determine access. In our Grafana use case, it adds a multi-factor authentication layer so that only authorized users can access our endpoint and subsequently login via Grafana username and password.

![[*Context-aware access: High-level architecture](https://cloud.google.com/blog/products/identity-security/cloud-iap-enables-context-aware-access-to-vms-via-ssh-and-rdp-without-bastion-hosts)*](https://cdn-images-1.medium.com/max/2400/0*QlJKAkFkutKVgt0t.png)*[*Context-aware access: High-level architecture](https://cloud.google.com/blog/products/identity-security/cloud-iap-enables-context-aware-access-to-vms-via-ssh-and-rdp-without-bastion-hosts)**

## Configuring IAP on GKE

Without further ado, letâ€™s configure IAP to secure access to Grafana. Some prerequisites before we begin:

* Global, reserved static IP

* SSL certificate

* Verified ownership of your domain

* GCP project compute.securityAdmin and compute.backendServices.update role (or Editor/Owner)

Assuming you have Cloud SDK installed (or using Cloud Shell):

    gcloud compute addresses create grafana-ip --global

If you already have an SSL certificate, you can mount it as a Kubernetes secret and skip to the next step. If not, we can use Googleâ€™s managed certificate option:

    apiVersion: networking.gke.io/v1beta2
    kind: ManagedCertificate
    metadata:
      name: **grafana-cert**
    spec:
      domains:
        - **grafana**.**example.com**

Save the file as cert.yaml and create the resource (takes about 15â€“20 mins to become active):

    kubectl apply -f cert.yaml

Finally, you need to verify the ownership of your domain. Use Googleâ€™s [webmaster tool](https://www.google.com/webmasters/#?modal_active=none) or register your domain with [Google Domains](https://domains.google/).

### Setting Up Ingress

IAP on GKE is enabled via GCE Ingress, which means that we need to expose our Grafana service as a NodePort for the HTTPS Load Balancer to pass its health checks. Modify Grafana Helm chart to use NodePort (service type is immutable so may need to delete and reinstall):

    helm upgrade grafana stable/grafana --set service.type=NodePort

Now letâ€™s create the ingress. You can define it within the Grafana Helm chart, but in case we want to apply the IAP to Prometheus or other services with the same ingress, Iâ€™m going to create it as a separate file (change bolded values as needed):

    apiVersion: networking.k8s.io/v1beta1
    kind: Ingress
    metadata:
      name: **ingress-monitoring**
      annotations:
        kubernetes.io/ingress.global-static-ip-name: **grafana-ip**
        networking.gke.io/managed-certificates: **grafana-cert**
    spec:
      rules:
      - host: **grafana.example.com
        **http:
          paths:
          - backend:
              serviceName: **grafana**
              servicePort: **80**

Save it as ingress-monitoring.yaml and deploy:

    kubectl apply -f ingress-monitoring.yaml

(If you are providing your own SSL certificate, use the following instead)

    apiVersion: networking.k8s.io/v1beta1
    kind: Ingress
    metadata:
      name: **ingress-monitoring**
      annotations:
        kubernetes.io/ingress.global-static-ip-name: **grafana-ip**
    spec:
      tls:
      - secretName: **my-cert-secret
      **rules:
      - host: **grafana.example.com
        **http:
          paths:
          - backend:
              serviceName: **grafana**
              servicePort: **80**

Once the ingress is healthy, [https://grafana.example.com](https://grafana.example.com) should redirect to your Grafana login page.

### Enabling IAP

First, we need to configure the projectâ€™s [OAuth consent screen](https://console.cloud.google.com/apis/credentials/consent?_ga=2.70534672.1206986393.1591391754-1171805911.1591391754):

![](https://cdn-images-1.medium.com/max/2300/1*hAtiqwCNZlNIWvkWB6NMvQ.png)

Since Grafana is an internal monitoring tool, choose **Internal,** and click **Create. **Fill out the **application name**, **support email, **and other optional fields:

![](https://cdn-images-1.medium.com/max/2000/1*m7iIS93Of8xGvNXY3w5wRQ.png)

Now, go to the [**Credentials](https://console.cloud.google.com/apis/credentials?_ga=2.39854242.1206986393.1591391754-1171805911.1591391754) **page** **to create the OAuth client credentials:

![](https://cdn-images-1.medium.com/max/2000/1*AXuZab5t39Mt2QBO9D2NlA.png)

**Application type **is **Web application, **give it a name and click **Create.** Make note of the client ID and secret that is generated and copy the ID to your clipboard.

Go back and select the OAuth application and add the following URL to the **authorized redirect URIs **section:

    https://iap.googleapis.com/v1/oauth/clientIds/**<MY_CLIENT_ID>**:handleRedirect

![](https://cdn-images-1.medium.com/max/2000/1*CEMdOVQ9bKPyA9HrYaCnsQ.png)

After saving the changes, itâ€™s time to use the OAuth credentials to configure the Kubernetes BackendConfig. Copy the Client ID and Secret Key to create a Kubernetes secret called iap-credentials :

    kubectl create secret generic iap-credentials \
      --from-literal=client_id=<**client_id_key>** \
      --from-literal=client_secret=<**client_secret_key>**

We can now use the secret to update the BackendConfig to enable our Ingresses to use IAP:

    apiVersion: cloud.google.com/v1
    kind: BackendConfig
    metadata:
      name: iap-config
    spec:
      iap:
        enabled: true
        oauthclientCredentials:
          secretName: iap-credentials

Deploy the BackendConfig changes: kubectl apply -f <backendconfig.yaml>

Finally, we need to update the annotations in Grafana services to associate our new BackendConfig to the NodePort (save as grafana.yaml):

    service:  
      type: NodePort  
      annotations: 
        beta.cloud.google.com/backend-config: '{"default": "iap-config"}'

Issue the Helm upgrade command:

    helm upgrade grafana stable/grafana -f grafana.yaml

(Note: if you run into issues, refer to [Googleâ€™s GKE IAP guide](https://cloud.google.com/iap/docs/enabling-kubernetes-howto) for debugging tips.)

### Configuring IAP access

Navigate back to the [IAP page](https://console.cloud.google.com/security/iap?_ga=2.104148736.1206986393.1591391754-1171805911.1591391754) and you should see the Grafana backend service for use:

![](https://cdn-images-1.medium.com/max/2344/1*B6gQYtrtLHOGkOxLg_tYgw.png)

Click on the IAP toggle button to turn on IAP. At this point, if you attempt to access Grafana over the Internet, you will be asked to authenticate with your Google credentials and be subsequently denied access:

![](https://cdn-images-1.medium.com/max/2000/1*nSJ6xCaZWzH5_jXOGczQpg.png)

In order to provide access, you must configure IAP settings and add members to your Grafana app. Click on the checkbox on the Grafana backend service, and a panel should appear on the right. Click **add member **and give **IAP-secured Web App User** role to users to access Grafana.

Once the Status turns from Error to Warning (it warns about internal firewall rules that can bypass IAP controls), you should now be able to access Grafana on the Internet after logging in with your Google account.

## Wrapping Up

While IAP provides an excellent alternative solution to using VPN or bastion hosts to lock down access to internal apps, it does present some challenges:

* Itâ€™s not possible to fully-automate this setup process (i.e. OAuth consent screen setup, generating client IDs and redirect URIs, etc)

* Using IAP in hybrid cloud settings is a bit more complicated (although thereâ€™s an excellent video on how [Airbnb does it here](https://www.youtube.com/watch?v=Sq9gp8KBsY0))

Overall, in this series, we looked at setting up a more production-ready monitoring stack using popular open-source tools. As the shift to cloud and cloud-native architectures continue to mature, scalable observability will be in more demand.

For more resources, check out:

* [Robust Perception](https://www.robustperception.io/)

* [Google SRE Book](https://landing.google.com/sre/sre-book/chapters/preface/)

* [Site Reliability Workbook](https://landing.google.com/sre/workbook/toc/)

* [Building Secure & Reliable Systems](https://static.googleusercontent.com/media/landing.google.com/en//sre/static/pdf/Building_Secure_and_Reliable_Systems.pdf)

To read other posts in these series:

* Part I: [Installing Prometheus + Grafana via Helm in 5 Minutes](https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-i-22d0f172f993)

* Part II: [Using Prometheus blackbox exporter for free uptime checks](https://medium.com/@yitaek/practical-monitoring-with-prometheus-grafana-part-ii-5020be20ebf6)

* Part III: [Applying simple statistics for anomaly detection using Prometheus](https://towardsdatascience.com/practical-monitoring-with-prometheus-grafana-part-iii-81f019ecee19)
